---
import Layout from "../../layouts/Layout.astro";
import {
  getProducts,
  getProductBySlug,
  getStrapiMedia,
} from "../../lib/strapi";
import { AddToCartButton } from "../../components/react/AddToCartButton";

// Esta función es necesaria para generar las rutas estáticas
export async function getStaticPaths() {
  const products = await getProducts();

  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product },
  }));
}

const { slug } = Astro.params;
const { product } = Astro.props;

if (!product) {
  return Astro.redirect("/404");
}

const { name, description, price, image, category, stock } = product;
const imageUrl = getStrapiMedia(image?.[0]?.url);

const cartItem = {
  id: product.id,
  name,
  price,
  slug,
  image: imageUrl,
};
---

<Layout title={name}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm">
      <ol class="flex items-center space-x-2 text-gray-500">
        <li><a href="/" class="hover:text-primary-600">Inicio</a></li>
        <li>/</li>
        <li>
          <a href="/productos" class="hover:text-primary-600">Productos</a>
        </li>
        {
          category && (
            <>
              <li>/</li>
              <li class="text-gray-700">{category.name}</li>
            </>
          )
        }
      </ol>
    </nav>

    <!-- Producto -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Imagen -->
      <div class="aspect-square overflow-hidden rounded-lg bg-gray-100">
        <img src={imageUrl} alt={name} class="w-full h-full object-cover" />
      </div>

      <!-- Información -->
      <div class="flex flex-col">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
          {name}
        </h1>

        {
          category && (
            <div class="mb-4">
              <span class="inline-block bg-primary-100 text-primary-800 text-sm font-semibold px-3 py-1 rounded-full">
                {category.name}
              </span>
            </div>
          )
        }

        <div class="text-4xl font-bold text-primary-600 mb-6">
          €{price.toFixed(2)}
        </div>

        {
          stock !== undefined && (
            <div class="mb-6">
              <span
                class={`text-sm font-semibold ${stock > 0 ? "text-green-600" : "text-red-600"}`}
              >
                {stock > 0 ? `En stock (${stock} disponibles)` : "Agotado"}
              </span>
            </div>
          )
        }

        <div class="prose prose-lg mb-8">
          <p class="text-gray-600">{description}</p>
        </div>

        {/* Botón de añadir al carrito */}
        <div class="mt-auto">
          <AddToCartButton client:only="react" product={cartItem} />
        </div>

        {/* Información adicional */}
        <div class="mt-8 pt-8 border-t border-gray-200">
          <h3 class="font-semibold text-gray-800 mb-4">
            Información adicional
          </h3>
          <ul class="space-y-2 text-gray-600">
            <li class="flex items-center gap-2">
              <svg
                class="w-5 h-5 text-green-500"
                fill="none"
                stroke-Linecap="round"
                stroke-Linejoin="round"
                stroke-Width="2"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path d="M5 13l4 4L19 7"></path>
              </svg>
              Pedido por WhatsApp
            </li>
            <li class="flex items-center gap-2">
              <svg
                class="w-5 h-5 text-green-500"
                fill="none"
                stroke-Linecap="round"
                stroke-Linejoin="round"
                stroke-Width="2"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path d="M5 13l4 4L19 7"></path>
              </svg>
              Atención personalizada
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</Layout>
